# Прогноз спроса и планирование рабочих смен(В рамках ЦМФ)
## Что надо сделать?
### Запланировать рабочие смены для курьеров на 7 дней вперед, чтобы покрыть весь спрос по заказам из сбер маркета
### ИЛИ (более строгая постановка задачи)
### Создать продукт (код), который на ежедневной основе "тригерит" функцию (F) для подсчета рабочих смен
Функция F:
1) Принимает
   - Таблицу с актуальной историей по заказам
   - Таблицу с опозданиями
2) Возвращает
   - Таблицу с расписанием рабочих смен
 
![expect](https://github.com/GraC2H5OH/Sber-Market-hackaton-cmf/blob/main/pics/Expected.png)

Здесь "shift_name" - это смены, а остальные столбцы это даты, которые мы прогнозируем, в столбцах указано необходимо количество курьеров. Также должна быть колонка, отвечающая за регион, в котором все это происходит.
## Как это сделать?
1) Прогнозируем количество заказов на 7 дней вперед
2) Исходя из этого количества заказов рассчитываем, сколько надо курьеров
3) Потребность в курьерах разбиваем на смены от 4 до 8 часов
## Какие данные есть?
У нас есть 2 датасета, в "orders" мы имеем дату, регион доставки и количество заказов. В "partners_delays" у нас есть дата, регион доставки, количество курьеров и частота опозданий курьеров.
![data](https://github.com/GraC2H5OH/Sber-Market-hackaton-cmf/blob/main/pics/available_data.png)
## Команда
1)Starchenko Nikita(это я)

2)Alexey Korchevnyy
## Распределение ролей, кто чем занимался
Nikita:
- Большая часть feature engineering
- Объединение моих признаков, и признаков, который сделал Alexey
- Обучение моделей
- Оптимизация рабочих смен курьеров

Alexey:
- Небольшой feature engineering
- Создание модели для прогнозирования количества заказов
- Попытка создания модели для прогнозирования числа курьеров
## Подробнее о том, что сделали в каждой задаче
### Feature engineering
Я добавил такие признаки как: является ли день праздником, сколько осталось дней до праздника, среднее по региону, медиана по региону, среднее за неделю, медиана за неделю, стандартное отклонение за неделю, корень, квадрат и логарифм таргета, день недели, является ли день выходным.

Alexey добавил такие признаки как: среднее за 7 часов, среднее за 14 часов и сумма 50% от этих фичей(предполагалось, что будут не часы, а дни)
### Прогнозирование числа заказов
Alexey предоставил мне для обучения регрессию и бустинг(lightGBM). После обучения и сравнивания метрик, мы выяснили, что бустинг лучше справляется со своей задачей. Сравнивали такие метрики как: R<sup>2</sup> (0.68 у регрессии) vs (0.7 у бустинга) и MAE (1.4 у регрессии) vs (1.38 у бустинга)

![metrics](https://github.com/GraC2H5OH/Sber-Market-hackaton-cmf/blob/main/pics/chart.png)
![feature_importance](https://github.com/GraC2H5OH/Sber-Market-hackaton-cmf/blob/main/pics/feature_importance.png)
### Оптимизация смен курьеров/разбиение курьеров на смены
Данную задачу я решал с помощью библиотеки gurobipy, это называется workforce scheduling optimization problem. Мой алгоритм хочет получить датасет, в котором есть дата, регион доставки, количество курьеров и количество заказов, на выходе мы получим датасет, в котором первый столбец будет отвечать за часы доставки (с 8 до 23), а все последующие будут иметь вид date_area, где date - дата, а area - зона доставки, и в строках будет указано, сколько курьеров нам необходимо.
## Что не сделали/не получилось
### Прогнозирование числа курьеров
Alexey пробовал различные подходы к этой задаче, от ARIMA до LSTM, но в связи с небольшим количеством времени(или небольшим количеством людей в команде(хакатон расчитан на команду из 5 человек)) мы не успели завершить данную задачу, LSTM не успела обучиться.
### Общая функция F
Так как мы не реализовали прогнозирование числа курьеров, то и функцию, которая объеденит все наши задачи мы не сделали
### Проблемы с предсказаниями количества заказов на 7 дней вперед
Признаки, которые мы считаем, чтобы обучить модель для предсказания количества заказов оказались немного не теми, которые должны были быть. Они прекрасно выполняют свою роль и благодаря ним мы получаем хорошие метрики, но например признак "среднее за неделю" считается на таргете каждого дня, то есть чтобы получить этот признак, мы уже должны знать таргет, который мы предсказываем, когда я осознал это, уже подошел конец дедлайна и я не успел это исправить.

Я вспомнил про эту проблему раньше и исправил ее на таких признаках как: корень, квадрат и логарифм из таргета, но тогда мы немного переделали датасет и каждая строка отвечала одному конкретному дню и теперь это исправление неактуально.
## Что в итоге?
Организатор хакатона оценил наши старания и указал на то, что мы придумали интересные признаки
